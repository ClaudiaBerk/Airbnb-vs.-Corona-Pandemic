---
title: "Data exploration file of Airbnb in the United Kingdom"
authors: "Team 2: Sanne van Ettinger, Claudia Berkhof, Demi van de Pol, Jurg Jacobs, Rob van der Wielen"
date: "2/25/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	message = FALSE,
	warning = FALSE,
	include = FALSE)
```

## Data Exploration
This document contains the code to programmatically download the raw data files from the InsideAirbnb website (insideairbnb.com). Besides that, information on the content of the raw data files and  variable definitions are provided. This RMarkdown document provides you with the codes to download the detailed listings data from AirBnB of the United Kingdom. Since the original data of 2021 is available in four different data files, divided per quarter, this document contains instructions on how to download and merge the four raw data files into one complete dataset for AirBnB data regarding to the United Kingdom. 

### Getting started
To download and eventually merge the different datasets you will first need to install and load the following packages in RStudio.

```{r Installing packages, include=FALSE}
# Install packages
install.packages("plyr")
install.packages("dplyr")
install.packages("tidyverse")
install.packages("ggplot2")
install.packages("readr")
install.packages("googledrive")
install.packages("caret")
install.packages("data.table")
install.packages("R.utils")
install.packages("dint")
install.packages("zoo")
```

```{r Loading packages, include=FALSE}
# Loading packages
library(plyr)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(readr)
library(googledrive)
library(caret)
library(data.table)
library(R.utils)
```

### Downloading the data from insideairbnb.com & merging it into one dataset
The code snippet below will tell you exactly how to download the data files of cities in the United Kingdom from InsideAirbnb. InsideAirbnb offers datasets from three cities in the United Kingdom: London (containing 4 quarters), Great Manchester (containing 4 quarters) and Bristol (containing 3 quarters). The needed URL's, in total 11, are collected in a Google Drive that is publically available via this link: https://docs.google.com/spreadsheets/d/1AzdybwMX-2QRfcolBv-2xT-5XKUeQpRhLBXtH1n47qM/. Besides downloading the data files, the code snippet below also directly binds the different datasets into one dataset.

```{r Download data from InsideAirbnb via Google Drive and merge it into one dataset, message=FALSE, warning=FALSE}
# importing the datasets from the Google Drive
data_id <- "1AzdybwMX-2QRfcolBv-2xT-5XKUeQpRhLBXtH1n47qM"  
drive_download(as_id(data_id), path = "listings_uk.csv", overwrite = TRUE)
df_drive <- read.csv("listings_uk.csv")

urls <- as.character(df_drive$link)

listings_uk <- lapply(urls, function(url) {
  print(paste0("Now downloading ... ", url))
  city = tolower(as.character(df_drive$city[match(url, df_drive$link)]))
  
  res = fread(url)
  res$city <- city
  return(res)
})

# merging the datasets into one dataset
data_airbnb_uk = do.call('rbind', listings_uk)

```

Now that the dataset is created, we want to save the raw data as an CSV file and store it in the data folder of this project on GitHub. This can be done by running the following code snippet:

```{r Export raw data file to CSV file}
# exporting the raw data file (data_uk) to a CSV file
write.csv(data_airbnb_uk, 'data_airbnb_uk.csv', row.names=F)

# saving raw data file in data folder

```

------
Note: Find out how to save the raw data into the data folder GitHub. Might ask Hannes??
------


### Solving 'issues' in the dataset (1)
As the data of 2021 is collected per quarter, and the purpose of this research is to compare different time periods, several new variables named "quarter", "year" and "year_quarter" should be created. By doing this, a distinction can be made between the different periods in time. Obviously, it is more orderly to have the newly created variables relocated after the variable "last_scraped" as the values from the variables "quarter", "year" and "year_quarter" are derived from this variable. All this can be done using the code snippet below.

```{r Create new variables: quarter, year, year_quarter}
# creating new variables
library("dint")
data_airbnb_uk$quarter <- get_quarter(data_airbnb_uk$last_scraped)
data_airbnb_uk$year <- get_year(data_airbnb_uk$last_scraped)

library("zoo")
data_airbnb_uk$year_quarter <- as.yearqtr(data_airbnb_uk$last_scraped, format="%Y-%m-%d")
data_airbnb_uk$year_quarter <- format(data_airbnb_uk$year_quarter, format = "%Y-%q")

# rearranging the order in the dataset
data_airbnb_uk <- data_airbnb_uk %>%
  relocate(quarter, .after = last_scraped) %>% 
  relocate(year, .after = quarter) %>% 
  relocate(year_quarter, .after = year)
```

------
Note Demi: Create new variable, name = quarter. 
------

------
Note: Maybe the following content should be in a second RMarkdown document as from here the cleaning part begins??
------

### Deleting unnecessary columns
As this research focuses on the main question "Which types of rooms in which neighborhoods benefited the most from the Corona Pandemic in the United Kingdom?", some variables in the original dataset might not be needed to come to an answer. For that reason only the following variables are kept in the dataset to maintain a clear overview of the variables needed for this research:
* id: Airbnb's unique identifier for the listing
* city: The city in which the Airbnb is located 
* quarter: The quarter in which the Airbnb is listed
* year: The year in which the Airbnb is listed 
* year_quarter: The year and quarter in which in the Airbnb is listed  
* neighborhood_cleansed: The neighborhood in which the Airbnb is located 
* room_type: The type of room the Airbnb offers 
* calculated_host_listings_count: The number of listings the host has in the current scrape, in the city / region geography 
* host_listings_count: The number of listings the host has (per Airbnb calculations)
* review_scores_rating: The overall rating of the Airbnb based on the review scores on a 0 to 5 scale
* price: The price at which the Airbnb is listed 

-----
Note Sanne: Later on, we add the variable review_scores_rating_rescaled. Should we also mention this one in the list above? Or do we choose - to keep it orderly - to change the review_scores_rating directly into the right 0-5 scale instead of making a new variable? That is also necessary to determine before we remove NA's. 
-----

The code below will copy the variables mentioned above into a new dataset, which then can be used to do analyses. 

```{r Delete unnecessary columns}
data_airbnb_uk_cleaned_1 <- data_airbnb_uk %>% 
  select(id, city, quarter, year, year_quarter, neighbourhood_cleansed, room_type, calculated_host_listings_count, review_scores_rating, price)
```

------
Note Demi: Decide which one to keep as there is a big difference between "calculated_host_listings_count" and "host_listings_count"
Claudia: Based on the meaning of the two variables (see above),  I think it is best to keep "calculated_host_listings_count", as we are only interested in our current city. However, tell me if you guys think otherwise
------


Now that the variables of interest are captured in a dataset let's take a look at the data by executing a summary to get a feeling for the data and see if we can add some meaning to the variables. 

```{r}
summary(data_airbnb_uk_cleaned_1)
```



### Solving 'issues' in the dataset (2)
#### Rescaling the variable "review_scores_rating"
From the results of the summary above can be observed that we have to take a closer look at the variable "review_scores_rating" as the range of this variable seems a bit out of proportion. As we inspect the data it becomes clear that the range of this variables has changed over time. In quarter 1 of 2021 the variable "review_scores_rating" ranges between 0 and 100. However, in the following quarters (2, 3 and 4) the variable "review_scores_rating" ranges between 0 and 5. This will lead to problems while analyzing the data. Therefore this needs to be taken care off by rescaling the variable. Below you will find the code to do so.

```{r Rescale the variable: review_scores_rating}

data_airbnb_uk_cleaned_1 <- data_airbnb_uk_cleaned_1 %>% 
  mutate(review_scores_rating_rescaled = ifelse(review_scores_rating>5,review_scores_rating/20, review_scores_rating))
  
```


#### Changing the variable "price"
Another 'issue' can be found looking at the variable "price". As you may have noticed in the summary,  the variable "price" in this data is imported as a character. This has to be changed to a numeric variables to include the variable "price" in any further analyses. Therefore the following code will remove the dollar sign. Also commas for prices above thousand are removed. Next the variables is changed from character to numeric. 

```{r Change the variable: price}
# Remove the dollar sign and commas (for prices above thousand)
data_airbnb_uk_cleaned_1$price <- gsub('[$,]', '', data_airbnb_uk_cleaned_1$price)

# Changing price variable from character to numeric
data_airbnb_uk_cleaned_1$price <- as.numeric(data_airbnb_uk_cleaned_1$price)

# Check for the results
class(data_airbnb_uk_cleaned_1$price)
```

------
Note: Rewrite the code with updated names, here use the dataset: data_airbnb_uk_cleaned_1.(ALREADY REWRITTEN, JUST CHECK IF ALL GOES WELL RUNNING IT)
------

```{r Checking the results of the issues solved}
summary(data_airbnb_uk_cleaned_1)

```


#### Finding the origin of the missing values
As seen in the statistics of the summary of the data a lot of data is missing from the variable "review_scores_rating". The missing data can have several reasons as for example technical issues. For the analyses later it is better to remove the observations with these so called NA's as these can bias the results of the analyses. The code snippet below removes the observations with the NA's and creates a new dataset. 

Almost all the missing value's (in the variables that we will use in our analysis) are in the rating score variable. About 90,000 missing values. The host listing_count has around 2,000 missing values, but that is a relative small number when having more than 300,000 observations. 

------
Note Jurg: Host_listings_count is not used, but is stated in the small text above. The only variable that has missing values is review rating score. 
------

```{r Finding out the origin of the missing values}

# First a dataset is created with the variables with only the oberservations that have NA's for the review score for comparison. 
data_airbnb_uk_na <- data_airbnb_uk[is.na(data_airbnb_uk$review_scores_rating),]

# Here are some interesting findings when comparing the data
# host is super_host
data_airbnb_uk %>%
  count(host_is_superhost)

data_airbnb_uk_na %>%
  count(host_is_superhost)

# for the dataset with na's only 3,8% is a  superhost and for the dataset without the na's it is 14%. 


# For these datasets the price also needs to be converted. 
# Remove the dollar sign and commas (for prices above thousand)
data_airbnb_uk$price <- gsub('[$,]', '', data_airbnb_uk$price)

# Changing price variable from character to numeric
data_airbnb_uk$price <- as.numeric(data_airbnb_uk$price)

# Check for the results
class(data_airbnb_uk$price)

# Remove the dollar sign and commas (for prices above thousand)
data_airbnb_uk_na$price <- gsub('[$,]', '', data_airbnb_uk_na$price)

# Changing price variable from character to numeric
data_airbnb_uk_na$price <- as.numeric(data_airbnb_uk_na$price)

# Check for the results
class(data_airbnb_uk_na$price)

# price
data_airbnb_uk %>%
summarize(mean(price))

data_airbnb_uk_na %>%
summarize(mean(price))


# Another reason that some listings have no reviews can be that the properties are new on Airbnb. 

# unfortunately there is no date for when the listing first appeared on Airbnb. But there is a date for when the host first appeared on Airbnb. So we will look at this variable. We will do this via plotting the data

# first extract how many times each data occurs in both the dataset without na's and the dataset with na's, 
data_host <- data_airbnb_uk %>%
  count(host_since)

data_host_na <- data_airbnb_uk_na %>%
  count(host_since)


# Then plot the data using ggplot


# plot the data for the dataset without na's using ggplot
ggplot(data = data_host, aes(x = host_since, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title = "Date of becoming a host",
              x = "Date", y = "Number of host")

# plot the data for the dataset with na's using ggplot
ggplot(data = data_host_na, aes(x = host_since, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title = "Date of becoming a host",
              x = "Date", y = "Number of host")

# as you can see these aren't really usable plots. It is better to look at it in years. 

# Lets convert the data to years for the dataset without na's
dates <- as.POSIXct(data_host$host_since, format="%Y-%m-%d")
dates_2 <- format(dates, format="%Y")
dates_2 <- as.data.frame(dates_2)

data_host$year <- dates_2$dates

# And now plot the data using ggplot
ggplot(data = data_host, aes(x = year, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title = "Date of becoming a host in years",
              x = "year", y = "Number of host")

# Better

# Now let's also do this for the dataset with na's.

# First convert the data to year
dates_na <- as.POSIXct(data_host_na$host_since, format="%Y-%m-%d")
dates_2_na <- format(dates_na, format="%Y")
dates_2_na <- as.data.frame(dates_2_na)

data_host_na$year <- dates_2_na$dates

# And now plot the data using ggplot.
ggplot(data = data_host_na, aes(x = year, y = n)) +
  geom_bar(stat = "identity", fill = "purple") +
  labs(title = "Date of becoming a host in years for the na dataset",
              x = "year", y = "Number of host")

# The plots do not differ much from each other. So the date is not the reason for the missing values. 


# There is also the possibility that hosts can switch off the possibility to give a review. When looking at the renting on Airbnb page on the Airbnb websites there is no indication that host have the possibility that they can switch off the possibility to give a review. 


```


-----
Note Jurg: Maybe divide the code snippet above in multiple snippets, so it will be more clearer. 
-----

##### Conclusion of the missing values
In the code snippet above we have tried to discover the origin of the missing values in the variable review_score_rating. We have used the variables host_is_superhost (i.e. whether or not the host is a superhost), price (i.e. price for 1 night) and host_since (i.e. since when the host joined AirBnB), however we could not find a clear cause for the missing values. 

On the AirBnB website is stated about reviews that it works in a couple of steps (https://www.airbnb.nl/help/article/13/recensies-over-verblijven?_set_bev_on_new_domain=1646646197_Y2Y0ZjE1MTdjMjJm): (1) After the stay, AirBnB asks the guests to write a review and give the amount of stars (1-5) for the trip or guest. (2) Write the review within 14 days after the stay, afterwards you can not change it anymore. (3) Reviews are only posted if a) both parties have submitted a review or b) the period of 14 days has expired, depending on what arises first.
It is also possible to give feedback in private to the host. This is shared only after the reviews are posted.

So,there is a high chance that the missing values of the variable review_rating_score are caused by guests or hosts that do not write a review. 

```{r Removing the NAs}
# Removing the NAs and create a new dataset without the NAs
data_airbnb_uk_cleaned_2 <- data_airbnb_uk_cleaned_1 %>% 
  drop_na(review_scores_rating, review_scores_rating_rescaled)
```

------
Note Rob: Create new dataset without the NA's, name = data_airbnb_uk_cleaned_2.
------

#### Seeking and determining polluting values 
To remove polluting data from the dataset, in order for the results to be ultimately representative, we run a boxplot for the numeric variables and a ggplot for the categorical variables as a visual approach to determine conspicuous values emerge. At a later point, these outliers are dealt with. The year-quarter related variables need no plotting, because the dataset is already filtered by those. The same goes for city. Also, id has nothing to do with polutted data, since it is in the dataset to identify a booking.

```{r Detecting outliers: neighbourhood_cleansed (1)}
# plot neighbourhood_cleansed
ggplot(data_airbnb_uk_cleaned_2, aes(neighbourhood_cleansed)) +
  geom_bar() +
  labs(y = "neighbourhood_cleansed_count")

# This does not look clean at all. Maybe a table is a more convenient way to look into this variable.

```
This does not look clean at all. Maybe a table is a more convenient way to look into this variable.

```{r Detecting outliers: neighbourhood_cleansed (2)}

data_airbnb_uk_cleaned_2 %>% 
  count(neighbourhood_cleansed, city, sort = TRUE)

# This looks more convenient

```

```{r Detecting outliers: room_type (1)}
# plot room_type
ggplot(data_airbnb_uk_cleaned_2, aes(room_type)) +
  geom_bar(stat = "count", fill = "red") +
  stat_count(geom = "text", colour = "black", size = 6,
             aes(label = ..count..), position = position_stack(vjust = 0.5)) +
  labs(y = "room_type_count")

# now the numbers are also present in the plot.

# The variable room_type clearly does not show many hotel rooms and shared rooms across from the other two types.

```

```{r Detecting outliers: room_type (2)}
# plot the room_types per city
ggplot(aes(x = room_type), data = data_airbnb_uk_cleaned_2) +
  geom_bar(aes(fill = city), colour = "grey20", lwd = 0.5) +
  stat_count(geom = "text", colour = "white", size = 5,
           aes(label=..count.., group=city), position = position_stack(vjust = 0.5)) +
  labs(y = "room_type_count")

# does the trick, but I do not know if it is useful.
```


```{r Detecting outliers calculated_host_listings_count}
# plot calculated_host_listings_count
boxplot(data_airbnb_uk_cleaned_2$calculated_host_listings_count,
  ylab = "calculated_host_listings_count"
)

# Calculated host listings has some outliers around 600 and around 900. 
```

```{r Detecting outliers: review_rating_score_rescaled}
# plot review_scores_rating_rescaled
boxplot(data_airbnb_uk_cleaned_2$review_scores_rating_rescaled,
  ylab = "review_scores_rating_rescaled_count"
)

# Review rating scores show a few outliers which are very low. We need to find out if these have a valuable reason.

```

----
Note Jurg: I do not think you can call these low numbers outliers, since we have rescaled the ratings score. Also a number of 0 on a 0-5 scale does not seem like an outlier.
----

```{r Detecting outliers: price}
boxplot(data_airbnb_uk_cleaned_2$price,
  ylab = "price")

# Finally, price needs to be looked at more closely because the outlier-parts are in the middle - in this case - but not necessarily present. 
```
